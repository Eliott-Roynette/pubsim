/*
 * To change this template, choose Tools | Templates
 * and open the template in the editor.
 */

package simulator.fes.crb;

import Jama.Matrix;
import java.util.Iterator;
import lattices.decoder.ZnWithinSphere;
import simulator.VectorFunctions;

/**
 * This is the Hammersley-Chapman-Robbins bound for frequency
 * estimation by phase unwrapping.  I have numerically computed the values
 * of an integral over a range in matlab.  The results are
 * contained in the array intvals.  This array is interpolated
 * to get the integral values.  See the matlab scripts in
 * Scripts/Matlab/fescrb.
 * @author Robby McKilliam
 */
public class Hamersley implements simulator.fes.crb.BoundCalculator {

    int N;
    double var, amplitude, ntn, nt1;
    double[] narray;
    
    /** Constructor.  The amplitude defaults to 1. */
    public Hamersley(){
        setAmplitude(1.0);
    }
    
    public void setN(int N) {
        this.N = N;
        narray = new double[this.N];
        ntn = 0.0; nt1 = 0.0;
        for(int i = 0; i < this.N; i++){
            narray[i] = i+1;
            ntn += (i+1)*(i+1);
            nt1 += i+1;
        }        
    }

    public void setVariance(double var) {
        this.var = var;
    }

    public void setAmplitude(double amp) {
        amplitude = amp;
    }

    public double getBound() {
        
        double dets = N/(ntn*N - nt1*nt1);
        double v = amplitude/Math.sqrt(var);
        
        if(v >= 1.0/0.1){
            System.out.println("Warning:  You are trying to compute fes/Hamerlsey bounds outside the range this program can handle.  It's going to look rubbish");
            return dets/(1000.0*intvals[0]);
        }
        if(v <= 1.0/5){
            System.out.println("Warning:  You are trying to compute fes/Hamerlsey bounds outside the range this program can handle.  It's going to look rubbish");
            return dets/(1000.0*intvals[intvals.length - 1]);
        }
        
        //do the linear interpoliation
        double vr = 1.0/v;
        int ind = (int)Math.floor((vr-0.1)/0.01);
        double below = 1.0/(ind*0.01 + 0.1);
        double above = 1.0/(ind*0.01 + 0.11);
        
        double grad = (intvals[ind+1] - intvals[ind])/(above - below);
        double intval = intvals[ind] + (v - below)*grad;
        
        return dets/(1000.0*intval);
    }
    
   /**
    * Calcuated using quad in matlab.  These are the values of an
    * integral for the parameter v = amp/sigma between the range
    * 1.0/[0.1:0.01:5].
    * Also these values need to be multilpied by 10^3.
   **/
   protected static double[] intvals = { 3.908770617892501,
   3.223696901428236,
   2.702673382869044,
   2.297226896528263,
   1.975551048032428,
   1.716074245757930,
   1.503747844529493,
   1.327814993235066,
   1.180421627358566,
   1.055725094116921,
   0.949306523140896,
   0.857774158337905,
   0.778489839918290,
   0.709376741080219,
   0.648781866071484,
   0.595376174848646,
   0.548081036637894,
   0.506013374286318,
   0.468444324521685,
   0.434767739311181,
   0.404475973747535,
   0.377141103523139,
   0.352400229255073,
   0.329943885321965,
   0.309506817742671,
   0.290860594809931,
   0.273807638636588,
   0.258176369577400,
   0.243817228717694,
   0.230599399284160,
   0.218408085742087,
   0.207142246524303,
   0.196712688517408,
   0.187040474997866,
   0.178055546307010,
   0.169695588982673,
   0.161905040002526,
   0.154634246977244,
   0.147838743269245,
   0.141478624458328,
   0.135518007788296,
   0.129924566961268,
   0.124669122230659,
   0.119725289075644,
   0.115069166525276,
   0.110679068911828,
   0.106535286798885,
   0.102619878486437,
   0.098916486112277,
   0.095410173307380,
   0.092087281220778,
   0.088935302981398,
   0.085942768394612,
   0.083099145123667,
   0.080394750015343,
   0.077820665192255,
   0.075368672750692,
   0.073031188607051,
   0.070801203474917,
   0.068672233489265,
   0.066638273466986,
   0.064693757383837,
   0.062833517258877,
   0.061052752257013,
   0.059346997263020,
   0.057712095733799,
   0.056144173200175,
   0.054639616801684,
   0.053195053120040,
   0.051807329820094,
   0.050473498569180,
   0.049190799466151,
   0.047956646830765,
   0.046768616220325,
   0.045624432554826,
   0.044521959427103,
   0.043459188395518,
   0.042434230974252,
   0.041445309468987,
   0.040490749454402,
   0.039568972672567,
   0.038678490492457,
   0.037817897880764,
   0.036985867839029,
   0.036181146266557,
   0.035402547212417,
   0.034648948483364,
   0.033919287577634,
   0.033212557917390,
   0.032527805355084,
   0.031864124931308,
   0.031220655943087,
   0.030596586928827,
   0.029991141177897,
   0.029403582475490,
   0.028833212390667,
   0.028280115817168,
   0.027741396547913,
   0.027218714440949,
   0.026710739430398,
   0.026216922937039,
   0.025736741776899,
   0.025269696762360,
   0.024815311392309,
   0.024373130624932,
   0.023942719727231,
   0.023523663195865,
   0.023115563744287,
   0.022718041351592,
   0.022330732368794,
   0.021953288678632,
   0.021585376905257,
   0.021226677670458,
   0.020876884893312,
   0.020535705130397,
   0.020202856953902,
   0.019878070310038,
   0.019561086188705,
   0.019251655762871,
   0.018949540137250,
   0.018654509790360,
   0.018366344133235,
   0.018084831162975,
   0.017809766998752,
   0.017540955529723,
   0.017278208061782,
   0.017021342982934,
   0.016770185446163,
   0.016524567068766,
   0.016284325387376,
   0.016049304629032,
   0.015819353888168,
   0.015594327929206,
   0.015374086692646,
   0.015158495074875,
   0.014947422718844,
   0.014740743814995,
   0.014538336861242,
   0.014340084686619,
   0.014145873971801,
   0.013955596416922,
   0.013769143998417,
   0.013586415680863,
   0.013407312663172,
   0.013231739406768,
   0.013059603506927,
   0.012890815570001,
   0.012725289096224,
   0.012562940367823,
   0.012403688342133,
   0.012247454549494,
   0.012094162995667,
   0.011943740068539,
   0.011796113720831,
   0.011651216346362,
   0.011508980155310,
   0.011369340235982,
   0.011232233623600,
   0.011097599254772,
   0.010965377898887,
   0.010835512092376,
   0.010707946075719,
   0.010582625674897,
   0.010459498475912,
   0.010338513420971,
   0.010219620987149,
   0.010102773077352,
   0.009987922971254,
   0.009875025278191,
   0.009764035891932,
   0.009654911947234,
   0.009547611778103,
   0.009442094877693,
   0.009338321859754,
   0.009236254421575,
   0.009135855308350,
   0.009037088278904,
   0.008939918072724,
   0.008844310378232,
   0.008750231802258,
   0.008657649840647,
   0.008566532849959,
   0.008476850020224,
   0.008388571348691,
   0.008301667614540,
   0.008216110354518,
   0.008131860978964,
   0.008048914301147,
   0.007967233022045,
   0.007886791482082,
   0.007807575092875,
   0.007729538517711,
   0.007652668515432,
   0.007576941904774,
   0.007502336078415,
   0.007428828985985,
   0.007356399117654,
   0.007285025488287,
   0.007214687622133,
   0.007145365538041,
   0.007077039735169,
   0.007009691179178,
   0.006943301288878,
   0.006877851923332,
   0.006813325369377,
   0.006749704329556,
   0.006686971910454,
   0.006625111611404,
   0.006564107313568,
   0.006503943269369,
   0.006444604092259,
   0.006386074746823,
   0.006328340539187,
   0.006271387107745,
   0.006215200414164,
   0.006159766734685,
   0.006105072651686,
   0.006051105045515,
   0.005997851086573,
   0.005945298227645,
   0.005893434196458,
   0.005842246988482,
   0.005791724859935,
   0.005741856321009,
   0.005692630129301,
   0.005644035283437,
   0.005596061016890,
   0.005548696791985,
   0.005501932294072,
   0.005455757425885,
   0.005410162302061,
   0.005365137243811,
   0.005320672773766,
   0.005276759610953,
   0.005233388665929,
   0.005190551036052,
   0.005148238000888,
   0.005106441017745,
   0.005065151717342,
   0.005024361899596,
   0.004984063529529,
   0.004944248733287,
   0.004904909794280,
   0.004866039149417,
   0.004827629385457,
   0.004789673235454,
   0.004752163575300,
   0.004715093420372,
   0.004678455922256,
   0.004642244365572,
   0.004606452164883,
   0.004571072861684,
   0.004536100121474,
   0.004501527730906,
   0.004467349595016,
   0.004433559734523,
   0.004400152283202,
   0.004367121485322,
   0.004334461693161,
   0.004302167364574,
   0.004270233060638,
   0.004238653552557,
   0.004207423382052,
   0.004176537516004,
   0.004145990905943,
   0.004115778595694,
   0.004085895719354,
   0.004056337499329,
   0.004027099244410,
   0.003998176347912,
   0.003969564285841,
   0.003941258615126,
   0.003913254971882,
   0.003885549069722,
   0.003858136698108,
   0.003831013720748,
   0.003804176074026,
   0.003777619765476,
   0.003751340872288,
   0.003725335539855,
   0.003699599980353,
   0.003674130471357,
   0.003648923354490,
   0.003623975034101,
   0.003599281975980,
   0.003574840706101,
   0.003550647809394,
   0.003526699928549,
   0.003502993762845,
   0.003479526067011,
   0.003456293650106,
   0.003433293374435,
   0.003410522154484,
   0.003387976955879,
   0.003365654794374,
   0.003343552734860,
   0.003321667890392,
   0.003299997421250,
   0.003278538534007,
   0.003257288480631,
   0.003236244557598,
   0.003215404105032,
   0.003194764505860,
   0.003174323184987,
   0.003154077608491,
   0.003134025282835,
   0.003114163754093,
   0.003094490607203,
   0.003075003465224,
   0.003055699988621,
   0.003036577874553,
   0.003017634856193,
   0.002998868702048,
   0.002980277215298,
   0.002961858233157,
   0.002943609626238,
   0.002925529297934,
   0.002907615183818,
   0.002889865251049,
   0.002872277497792,
   0.002854849952657,
   0.002837580674139,
   0.002820467750078,
   0.002803509297129,
   0.002786703460240,
   0.002770048412144,
   0.002753542352862,
   0.002737183509212,
   0.002720970134334,
   0.002704900507223,
   0.002688972932268,
   0.002673185738802,
   0.002657537280670,
   0.002642025935789,
   0.002626650105734,
   0.002611408215322,
   0.002596298712205,
   0.002581320135286,
   0.002566470838741,
   0.002551749405552,
   0.002537154370836,
   0.002522684290644,
   0.002508337741601,
   0.002494113320559,
   0.002480009644246,
   0.002466025348936,
   0.002452159090113,
   0.002438409542151,
   0.002424775397992,
   0.002411255368839,
   0.002397848183846,
   0.002384552589825,
   0.002371367350943,
   0.002358291248443,
   0.002345323080357,
   0.002332461661229,
   0.002319705821844,
   0.002307054408964,
   0.002294506285062,
   0.002282060328069,
   0.002269715431121,
   0.002257470502314,
   0.002245324464460,
   0.002233276254848,
   0.002221324825017,
   0.002209469140520,
   0.002197708180705,
   0.002186040938492,
   0.002174466420157,
   0.002162983645120,
   0.002151591645740,
   0.002140289467105,
   0.002129076166835,
   0.002117950814884,
   0.002106912493349,
   0.002095960296274,
   0.002085093329472,
   0.002074310710336,
   0.002063611543589,
   0.002052995017443,
   0.002042460258854,
   0.002032006429776,
   0.002021632702882,
   0.002011338261394,
   0.002001122298924,
   0.001990984019317,
   0.001980922636494,
   0.001970937374298,
   0.001961027466349,
   0.001951192155889,
   0.001941430695644,
   0.001931742347680,
   0.001922126383258,
   0.001912582082706,
   0.001903108735276,
   0.001893705639015,
   0.001884372100634,
   0.001875107435380,
   0.001865910966911,
   0.001856782027170,
   0.001847719956264,
   0.001838724102349,
   0.001829793821505,
   0.001820928477625,
   0.001812127442303,
   0.001803390094718,
   0.001794715760654,
   0.001786103956363,
   0.001777554021779,
   0.001769065365350,
   0.001760637402583,
   0.001752269555940,
   0.001743961254740,
   0.001735711935061,
   0.001727521039645,
   0.001719388017802,
   0.001711312325319,
   0.001703293424368,
   0.001695330783416,
   0.001687423877138,
   0.001679572186328,
   0.001671775197815,
   0.001664032404380,
   0.001656343304671,
   0.001648707403124,
   0.001641124209880,
   0.001633593240709,
   0.001626114016934,
   0.001618686065348,
   0.001611308918148,
   0.001603982112853,
   0.001596705192237,
   0.001589477704255,
   0.001582299201974,
   0.001575169243501,
   0.001568087391920,
   0.001561053215219,
   0.001554066286228,
   0.001547126182553,
   0.001540232486512,
   0.001533384785070,
   0.001526582669782,
   0.001519825736727,
   0.001513113586450,
   0.001506445823902,
   0.001499822058385,
   0.001493241903489,
   0.001486704977041,
   0.001480210901045,
   0.001473759301633,
   0.001467349809002,
   0.001460982057371,
   0.001454655684922,
   0.001448370333751,
   0.001442125649817,
   0.001435921333055,
   0.001429762029370,
   0.001423637221975,
   0.001417551703623,
   0.001411505138849,
   0.001405497195762,
   0.001399527546002,
   0.001393595864690,
   0.001387701830388,
   0.001381845125053,
   0.001376025433996,
   0.001370242445837,
   0.001364495852466,
   0.001358785349000,
   0.001353110633744,
   0.001347471408148,
   0.001341867376773,
   0.001336298247248,
   0.001330763730230,
   0.001325263539374,
   0.001319797391289,
   0.001314365005503,
   0.001308966104429,
   0.001303600413327,
   0.001298267660271,
   0.001292967576112,
   0.001287699894448,
   0.001282464351587,
   0.001277260686513,
   0.001272088640859,
   0.001266947958868,
   0.001261838387368,
   0.001256759675733,
   0.001251711575860,
   0.001246693842135,
   0.001241706231403,
   };
    

}
